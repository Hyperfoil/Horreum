version: '3.1'
services:
  horreum:
    image: quay.io/hyperfoil/horreum:${HORREUM_COMMIT_ID}
    environment:
      - "QUARKUS_DATASOURCE_JDBC_URL=${HORREUM_QUARKUS_DATASOURCE_JDBC_URL}"
      - "QUARKUS_DATASOURCE_MIGRATION_JDBC_URL=${HORREUM_QUARKUS_DATASOURCE_JDBC_URL}"
      - QUARKUS_DATASOURCE_USERNAME=appuser
      - QUARKUS_HTTP_HTTP2=false
      - "HORREUM_INTERNAL_URL=${HORREUM_HORREUM_INTERNAL_URL}"
      - "HORREUM_KEYCLOAK_URL=${HORREUM_HORREUM_KEYCLOAK_URL}"
      - "HORREUM_URL=${HORREUM_HORREUM_URL}"
      - "QUARKUS_DATASOURCE_MIGRATION_PASSWORD=${QUARKUS_DATASOURCE_MIGRATION_PASSWORD}"
      - QUARKUS_DATASOURCE_PASSWORD=${QUARKUS_DATASOURCE_PASSWORD}
      - "QUARKUS_OIDC_AUTH_SERVER_URL=${HORREUM_QUARKUS_OIDC_AUTH_SERVER_URL}"
      - QUARKUS_LOG_LEVEL=INFO
      - HORREUM_GRAFANA_ADMIN_PASSWORD=${HORREUM_GRAFANA_ADMIN_PASSWORD}
      - "HORREUM_GRAFANA_MP_REST_URL=${GRAFANA_GF_SERVER_ROOT_URL}"
      - "HORREUM_GRAFANA_URL=${GRAFANA_GF_SERVER_ROOT_URL}"
      - HORREUM_TEST=true
      - "JAVA_OPTIONS=${CONTAINER_JAVA_OPTIONS}"
      - "QUARKUS_HTTP_PORT=${HORREUM_HTTP_PORT}"
      - "QUARKUS_HTTP_SSL_PORT=${HORREUM_HTTPS_PORT}"
    env_file: horreum-backend/.env
    network_mode: host
    stop_signal: SIGKILL
    volumes:
      - ./:/etc/horreum/certs:ro,z
      - ./:/cwd:rw,z
