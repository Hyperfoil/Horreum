version: '3.1'
services:
  horreum:
    image: quay.io/hyperfoil/horreum:latest
    entrypoint: sh -c "/cwd/scripts/horreum.sh $PORT_OFFSET"
    environment:
      - "QUARKUS_DATASOURCE_JDBC_URL=${HORREUM_QUARKUS_DATASOURCE_JDBC_URL}"
      - "QUARKUS_DATASOURCE_MIGRATION_JDBC_URL=${HORREUM_QUARKUS_DATASOURCE_JDBC_URL}"
      - QUARKUS_DATASOURCE_USERNAME=appuser
      - QUARKUS_HTTP_HTTP2=false
      - "HORREUM_INTERNAL_URL=${HORREUM_HORREUM_INTERNAL_URL}"
      - "HORREUM_KEYCLOAK_URL=${HORREUM_HORREUM_KEYCLOAK_URL}"
      - "HORREUM_URL=${HORREUM_HORREUM_URL}"
      - QUARKUS_DATASOURCE_MIGRATION_PASSWORD=secret
      - QUARKUS_DATASOURCE_PASSWORD=secret
      - "QUARKUS_OIDC_AUTH_SERVER_URL=${HORREUM_QUARKUS_OIDC_AUTH_SERVER_URL}"
      - QUARKUS_LOG_LEVEL=INFO
      - HORREUM_GRAFANA_ADMIN_PASSWORD=secret
      - "HORREUM_GRAFANA_MP_REST_URL=${GRAFANA_GF_SERVER_ROOT_URL}"
      - "HORREUM_GRAFANA_URL=${GRAFANA_GF_SERVER_ROOT_URL}"

    ports:
      - "${HORREUM_HTTPS_PORT}:8443"
      - "${HORREUM_HTTP_PORT}:8080"
    volumes:
      - ./src/main/resources/certs:/etc/horreum/certs:ro,z
      - ./:/cwd:rw,z
